<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coinbase Top Movers</title>

    <!-- CSS externo -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

<div class="page-wrapper">
    <div class="card" id="top-movers-card">
    <div class="card-header card-header-collapsible">
    	    <h1>
      	  	 ðŸ“ˆ Coinbase Top Movers
        		<span class="badge">
            		{% if frequency == "5m" %} 5m
            		{% elif frequency == "15m" %} 15m
            		{% elif frequency == "1h" %} 1h
            		{% elif frequency == "6h" %} 6h
            		{% else %} 1d
            		{% endif %}
        		</span>
    	    </h1>
 <!-- MISMA LÃ“GICA QUE AVAILABLE MARKETS -->
    <button 
      type="button" 
      class="btn-toggle" 
      onclick="toggleCard('top-movers-card')">
      âˆ’
    </button>
        </div>

        <div class="card-body">
            <!-- Filtros -->
            <form method="post">
		<input type="hidden" name="form_id" value="top_movers">

        <!-- Snapshot para NO recalcular Top Movers -->
        {% if results %}
            <input type="hidden" name="top_movers_snapshot" value='{{ results | tojson }}'>
        {% endif %}

        <!-- Estado actual de los filtros de Top Movers -->
        <input type="hidden" name="selected_quote" value="{{ selected_quote or '' }}">
        <input type="hidden" name="top_n" value="{{ top_n }}">
        
	<!-- âŒ AQUÃ quitamos el hidden movement_filter -->
        <!-- âœ… Radios serÃ¡n la Ãºnica fuente de movement_filter -->
	<!-- input type="hidden" name="movement_filter" value="{{ movement_filter }}" -->
        <!-- OJO: aquÃ­ ya NO ponemos hidden frequency -->
        <!-- input type="hidden" name="frequency" value="{{ frequency }}" -->

                <div class="filter-row">
                    <div class="filter-group">
                        <label for="quote_currency">Quote currency</label>
                        <select name="quote_currency" id="quote_currency" required>
                            <option value="">-- Select --</option>
                            {% for q in quotes %}
                                <option value="{{ q }}" {% if selected_quote == q %}selected{% endif %}>{{ q }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group" style="max-width: 120px;">
                        <label for="top_n">Top N</label>
                        <input type="number" name="top_n" id="top_n" value="{{ top_n }}" min="1" max="50">
                    </div>

		<!-- NUEVO: filtro de movimiento -->
		<div class="filter-group">
			<label>Movement</label>
    			<div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.8rem;">
        			<label>
            				<input type="radio" name="movement_filter" value="all"
                   				{% if movement_filter == "all" %}checked{% endif %}>
            				All
        			</label>
        			<label>
            				<input type="radio" name="movement_filter" value="positive"
                   				{% if movement_filter == "positive" %}checked{% endif %}>
            				Positive
        			</label>
        			<label>
            				<input type="radio" name="movement_filter" value="negative"
                   				{% if movement_filter == "negative" %}checked{% endif %}>
            				Negative
        			</label>
    			</div>
		</div>

		<!-- NUEVO: selector de frecuencia -->
		<div class="filter-group" style="max-width: 150px;">
    			<label for="frequency">Frequency</label>
    			<select name="frequency" id="frequency">
        			<option value="5m"  {% if frequency == "5m"  %}selected{% endif %}>5 minutes</option>
        			<option value="15m" {% if frequency == "15m" %}selected{% endif %}>15 minutes</option>
        			<option value="1h"  {% if frequency == "1h"  %}selected{% endif %}>1 hour</option>
        			<option value="6h"  {% if frequency == "6h"  %}selected{% endif %}>6 hours</option>
        			<option value="1d"  {% if frequency == "1d"  %}selected{% endif %}>1 day</option>
    			</select>
		</div>
                    <div>
                        <button type="submit">Get Top Movers</button>
                    </div>
                </div>
            </form>

            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}

            {% if results %}
                <p class="subtitle">
                    Showing top {{ results|length }} movers for
                    <strong>{{ selected_quote }}</strong>,
		    frequency <strong>{{ frequency }}</strong>,
		    (
        	    {% if movement_filter == "all" %}
            		all movements
        	    {% elif movement_filter == "positive" %}
            		positive only
        	    {% else %}
            		negative only
        	    {% endif %}
        	    ).
		</p>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Base</th>
                            <th>Quote</th>
                            <th>Open</th>
                            <th>Last</th>
                            <th>Change {{ frequency }} (%)</th>
                            <th>Trade</th>
			                <th>Monitor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in results %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ r.display_name }}</td>
                                <td>{{ r.base_currency }}</td>
                                <td>{{ r.quote_currency }}</td>

                                <td>{{ "%.6f"|format(r.open) }}</td>
                                <td>{{ "%.6f"|format(r.last) }}</td>

                                {% set cls = "positive" if r.change_pct >= 0 else "negative" %}
                                <td class="{{ cls }}">
                                    {{ "%.2f"|format(r.change_pct) }}%
                                </td>

                                <td>
                                    <a class="trade-btn"
                                       href="https://www.coinbase.com/advanced-trade/spot/{{ r.product_id }}"
                                       target="_blank">
                                        Open
                                        <span style="font-size: 0.7rem;">â†—</span>
                                    </a>
                                </td>

				<td>
				  <button class="btn-monitor" onclick="addToWatchlist('{{ r.product_id }}', {{ r.last }})">
						Send to Watchlist
				  </button>
				</td>

                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% elif selected_quote %}
                <p class="subtitle">No results found for this quote currency.</p>
            {% endif %}

            <div class="footer">
                <span>Last refresh (server UTC): {{ now }}</span>
                <span>Source: Coinbase public API Â· Exchange</span>
            </div>
        </div> <!-- cierre de .card-body (Top Movers) -->
    </div> <!-- cierre de .card (Top Movers) -->


<!-- ========================= -->
<!--   CARD 2: AVAILABLE MARKETS -->
<!-- ========================= -->
<!-- CARD 2: AVAILABLE MARKETS -->
<div class="card" id="available-markets-card" style="margin-top: 24px;">
    <div class="card-header card-header-collapsible">
        <h1>
            ðŸ“š Available Markets
            {% if markets_quote_currency %}
                <span class="badge">{{ markets_quote_currency }}</span>
            {% endif %}
        </h1>
        <button type="button" class="btn-toggle" onclick="toggleCard('available-markets-card')">
            âˆ’
        </button>
    </div>

    <div class="card-body">
        <form method="post">
            <input type="hidden" name="form_id" value="markets">

            <!-- âœ… NUEVO: snapshot de los Top Movers para NO recalcular ni perderlos -->
            {% if results %}
                <input type="hidden" name="top_movers_snapshot" value='{{ results | tojson }}'>
            {% endif %}

            <!-- âœ… NUEVO: estado actual de los filtros de Top Movers -->
            <input type="hidden" name="selected_quote" value="{{ selected_quote or '' }}">
            <input type="hidden" name="top_n" value="{{ top_n }}">
            <input type="hidden" name="movement_filter" value="{{ movement_filter }}">
            <input type="hidden" name="frequency" value="{{ frequency }}">


            <div class="filter-row">
                <div class="filter-group">
                    <label for="markets_quote_currency">Quote currency</label>
                    <select name="markets_quote_currency" id="markets_quote_currency" required>
                        <option value="">-- Select --</option>
                        {% for q in quotes %}
                            <option value="{{ q }}" {% if markets_quote_currency == q %}selected{% endif %}>{{ q }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <button type="submit">Get Markets</button>
                </div>
            </div>
        </form>

        {% if markets_products %}
            <p class="subtitle">
                Select a pair to add it to the realtime watchlist.  
                Showing <strong>{{ markets_products|length }}</strong> online markets for
                <strong>{{ markets_quote_currency }}</strong>.
            </p>
	    <!-- LISTA SCROLL -->
            <div class="markets-list">
                {% for p in markets_products %}
                    <div class="market-item">
                        <div class="market-info">
                            <div class="market-name">
                                {{ p.display_name }}
                            </div>
                            <div class="market-sub">
                                {{ p.base_currency }} / {{ p.quote_currency }}
                                Â· status: {{ p.status }}
                            </div>
                        </div>
                        <div class="market-actions">
                            <button
                                type="button"
                                class="btn-monitor"
                                onclick="addToWatchlistFromMarkets('{{ p.product_id }}')">
                                Monitor
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif markets_quote_currency %}
            <p class="subtitle">
                No online markets found for <strong>{{ markets_quote_currency }}</strong>.
            </p>
        {% endif %}
    </div>
</div> <!-- cierre de .card (Available Markets) -->




    <!-- NUEVA CARD: Realtime Watchlist -->
    <div class="card" id="realtime-watchlist-card" style="margin-top: 24px;">
        <div class="card-header card-header-collapsible">
             <h1>
                ðŸ‘€ Realtime Watchlist
            </h1>
            <!-- MISMO PATRÃ“N QUE LAS OTRAS CARDS -->
            <button 
                type="button" 
                class="btn-toggle" 
                onclick="toggleCard('realtime-watchlist-card')">
                âˆ’
            </button>
        </div>

        <div class="card-body">
            <p class="subtitle">
                Select pairs from the Top Movers table to add them here and track live price changes every 5 seconds.
            </p>

            <table id="watchlist-table">
                <thead>
                    <tr>
                        <th>Pair</th>
                        <th>Initial Price</th>
                        <th>Last Price</th>
                        <th>Change (%)</th>
                        <th>Added At</th>
                        <th>Elapsed</th>
                        <th>Graph</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody id="watchlist-body">
                    <!-- filas generadas por JS -->
                </tbody>
            </table>
        </div>
    </div> <!-- cierre de .card (Watchlist) -->

</div> <!-- cierre de .page-wrapper -->

<!-- JS externo (si aplica) -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>

